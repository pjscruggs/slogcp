name: Go Tests and Checks

on:
  workflow_call:

permissions:
  contents: read

jobs:
  test-and-vuln-check:
    name: 🧪📊 Run Tests & Vuln Check
    runs-on: ubuntu-latest
    steps:
      - name: 🛒 Checkout Code
        uses: actions/checkout@v4

      - name: 🏗️ Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: 🧪 Run Go Tests
        id: go-test
        run: |
          go test -v -race -tags='!e2e' -coverprofile=coverage.txt ./...

      - name: 📄 Print Coverage Report
        if: steps.go-test.outcome == 'success' || steps.go-test.outcome == 'failure'
        run: |
          echo "--- Test Coverage ---"
          if [ -f coverage.txt ]; then
            cat coverage.txt
          else
            echo "Coverage file (coverage.txt) not found."
          fi
          echo "---------------------"

      - name: ❌ Check Test Execution Status
        if: steps.go-test.outcome == 'failure'
        run: |
          echo "❌ Go tests failed. Review logs above."
          exit 1

      - name: ✅ Report Test Success
        if: steps.go-test.outcome == 'success'
        run: |
          echo "✅ All Go tests passed!"

      - name: 🛡️🔍 Run Vulnerability Check
        if: steps.go-test.outcome == 'success'
        run: |
          echo "Running vulnerability check..."
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...