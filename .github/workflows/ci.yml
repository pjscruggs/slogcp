name: CI

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  merge_group:
    types: [ checks_requested ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read

jobs:
  format-lint-1:
    name: 🧹 Initial Format & Lint
    uses: ./.github/workflows/go-format-lint.yml

  license-header:
    name: 🛡️ Fix License Headers
    needs: [format-lint-1]
    uses: ./.github/workflows/license-header.yml

  format-lint-2:
    name: 🧹 Re-run Format & Lint
    needs: [license-header]
    uses: ./.github/workflows/go-format-lint.yml

  test:
    name: 🧪 Run & Report Tests
    needs: [format-lint-2]
    uses: ./.github/workflows/go-tests.yml

  aggregate-checks:
    name: ✅ All Checks
    if: always()
    needs: [format-lint-1, license-header, format-lint-2, test]
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        run: |
          echo "Initial Format & Lint: ${{ needs.format-lint-1.result }}"
          echo "License Headers:       ${{ needs.license-header.result }}"
          echo "Re-run Format & Lint:  ${{ needs.format-lint-2.result }}"
          echo "Tests:                 ${{ needs.test.result }}"
          if [[ "${{ needs.format-lint-1.result }}" == "success" \
            && "${{ needs.license-header.result }}" == "success" \
            && "${{ needs.format-lint-2.result }}" == "success" \
            && "${{ needs.test.result }}" == "success" ]]; then
            echo "🎉 All checks passed!"
            exit 0
          else
            echo "❗ One or more steps failed."
            exit 1
          fi

  build:
    name: 📦 Build
    needs: [aggregate-checks]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@0aaccfd150d50ccaeb58ebd88d36e91967a5f35b # v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Determine version
        id: get_version
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            git fetch --tags --force
            echo "version=$(git describe --tags --abbrev=0)" >> $GITHUB_OUTPUT
          fi

      - name: Build with injected version
        run: |
          go build \
            -ldflags="-X 'github.com/pjscruggs/slogcp.Version=${{ steps.get_version.outputs.version }}'" \
            -o slogcp ./cmd/slogcp
